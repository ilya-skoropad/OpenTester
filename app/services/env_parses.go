package services

import (
	"fmt"
	"ilya-skoropad/open-tester/models"
	"log"
	"os"
	"strconv"
	"strings"
)

type EnvParser struct {
	fileName string
	model    models.DbCredentials
}

type envLine struct {
	Key string
	Val string
}

func (p *EnvParser) SetFile(fileName string) {
	p.fileName = fileName
}

func (p *EnvParser) Parse() models.DbCredentials {
	data, err := os.ReadFile(p.fileName)

	if err != nil {
		log.Fatal("can not open env file")
	}

	lines := strings.Split(string(data), fmt.Sprintln(""))
	for _, line := range lines {
		parsedLine := p.splitLine(line)
		p.fillModel(parsedLine.Key, parsedLine.Val)
	}

	return p.model
}

func (p *EnvParser) splitLine(line string) envLine {
	data := strings.Split(string(line), "=")
	var res envLine

	if len(data) == 2 {
		res.Key = data[0]
		res.Val = data[1]
	}

	return res
}

func (p *EnvParser) fillModel(field string, data string) {
	switch field {
	case "HOST":
		p.model.Host = data
	case "PORT":
		p.model.Port, _ = strconv.Atoi(data)
	case "USER":
		p.model.User = data
	case "PASSWORD":
		p.model.Password = data
	case "DBNAME":
		p.model.DbName = data

	}
}
